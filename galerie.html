<script>
    const romansConfig = [
        { id: 1, nom: "Shadrasy", public: true }, { id: 2, nom: "NÃ©buleuse Alpha", public: false },
        { id: 3, nom: "Projet Onyx", public: false }, { id: 4, nom: "Saga Echo", public: true },
        { id: 5, nom: "Protocole Silence", public: false }, { id: 6, nom: "Code Hinaru", public: false },
        { id: 7, nom: "Saga Origin", public: false }, { id: 8, nom: "Echo Stellaire", public: false },
        { id: 9, nom: "Signal Perdu", public: false }, { id: 10, nom: "Archives W10", public: false },
        { id: 11, nom: "Module Externe", public: false }, { id: 12, nom: "L'Eveil", public: false },
        { id: 13, nom: "Pipeline Final", public: false }, { id: 14, nom: "Projet 14", public: false }
    ];

    const urlParams = new URLSearchParams(window.location.search);
    const isHinaru = urlParams.get('Hinaru') === 'true';
    const projetActuel = parseInt(urlParams.get('projet')) || 1;

    if (isHinaru) document.getElementById('master-panel').style.display = 'block';

    function ecouterScanner() {
        const syncData = localStorage.getItem('hinaru_cosmos_sync');
        if(syncData) {
            const config = JSON.parse(syncData);
            const status = document.getElementById('signals-status');
            status.innerText = `SIGNALS_TRACKED: GPS_LINKED (MODE: ${config.mode})`;
            status.style.color = "cyan"; status.style.borderColor = "cyan";
        }
    }

    function afficherProtocole(type) {
        const display = document.getElementById('protocol-display');
        const content = document.getElementById('protocol-content');
        display.style.display = 'block';
        const protocoles = {
            'methode': "<b>[ PIPELINE 13 MODULES ]</b><br>â€¢ W1-W5 : Conceptualisation 3D<br>â€¢ W6-W9 : Studio Fusion<br>â€¢ W10-W13 : Rendu Master Final 4K",
            'industriel': "<b>[ STANDARDS MÃ‰TIER ]</b><br>â€¢ Hard Lore Consistency<br>â€¢ Industrial Pipeline Standards",
            'philosophie': "<b>[ PROTOCOLE SILENCE ]</b><br>â€¢ Le visuel installe l'Ã¢me.<br>â€¢ ZÃ©ro pollution visuelle."
        };
        content.innerHTML = protocoles[type] || "SIGNAL INCONNU";
    }

    function chargerGalerie() {
        const container = document.getElementById('galerie-container');
        const fanContainer = document.getElementById('fan-cosplay-container');
        const worldContainer = document.getElementById('world-container');
        const nav = document.getElementById('nav-buttons');

        // SÃ‰CURITÃ‰ : Attente du chargement des donnÃ©es
        if (typeof archivesData === 'undefined') {
            setTimeout(chargerGalerie, 100);
            return;
        }
        
        container.innerHTML = ""; fanContainer.innerHTML = ""; worldContainer.innerHTML = ""; nav.innerHTML = "";

        // GÃ©nÃ©ration des boutons de navigation (R1 Ã  R14)
        romansConfig.forEach(r => {
            if (isHinaru || r.public) {
                const btn = document.createElement('button');
                btn.className = "btn-action";
                btn.style.cssText = "border-color:white; color:white; margin:5px; padding:8px 15px; background:none; cursor:pointer;";
                btn.innerText = `R${r.id}: ${r.nom.toUpperCase()}`;
                if(r.id === projetActuel) btn.style.borderColor = "var(--vhs-vert)";
                btn.onclick = () => { 
                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.set('projet', r.id);
                    if(isHinaru) newUrl.searchParams.set('Hinaru', 'true');
                    window.location.href = newUrl.toString();
                };
                nav.appendChild(btn);
            }
        });

        // Filtrage des donnÃ©es par roman
        const now = new Date();
        const filteredData = archivesData.filter(item => item.roman === projetActuel);

        if (filteredData.length === 0) {
            container.innerHTML = "<p style='color:orange; letter-spacing:2px;'>[ AUCUNE ARCHIVE DÃ‰TECTÃ‰E DANS CE SECTEUR ]</p>";
        }

        filteredData.forEach((item, index) => {
            const releaseDate = new Date(item.date);
            if (!isHinaru && now < releaseDate) return;

            const box = document.createElement('div');
            box.className = 'box';
            
            const hud = item.tech ? `<div class="hud-technique" style="position:absolute; bottom:10px; left:10px; font-size:9px; background:rgba(0,0,0,0.7); padding:5px; color:var(--vhs-vert); text-align:left; pointer-events:none;"><b>CINEMATIC_SCAN</b><br>${item.tech.split('\n').map(l=>`> ${l}`).join('<br>')}</div>` : "";
            const badge = item.nom && (item.nom.includes("Hinaru") || item.nom.includes("Creator")) ? `<div class="creator-badge" style="position:absolute; top:10px; right:10px; background:var(--vhs-vert); color:black; font-size:9px; padding:2px 5px; font-weight:bold; z-index:5;">ORIGINAL CREATOR</div>` : "";

            let media = item.glb ? `<model-viewer src="${item.glb}" poster="${item.url}" auto-rotate camera-controls style="width:100%; height:100%;"></model-viewer>` : `<img src="${item.url}" style="width:100%; height:100%; object-fit:cover;">`;

            box.innerHTML = `
                <div class="image-frame" style="position:relative; width:100%; height:380px; background:#050505; border:1px solid #333; overflow:hidden;">
                    ${badge}${media}${hud}
                </div>
                <div style="font-size:12px; text-align:left; color:var(--bleu-tech); margin:10px 0;">
                    <b>ID: #${index + 1000}</b> | TYPE: ${item.type.toUpperCase()} | TOME: ${item.tome || '1'}
                </div>`;

            // --- BOUTON IMMERSION ZQSD OPTIMISÃ‰ ---
            if (item.glb) {
                const btnImmersion = document.createElement('button');
                btnImmersion.className = "btn-action";
                btnImmersion.style.cssText = `
                    width:100%; 
                    border:1px solid var(--vhs-vert); 
                    color:var(--vhs-vert); 
                    background:rgba(0,255,65,0.05); 
                    padding:12px; 
                    font-weight:bold; 
                    cursor:pointer; 
                    font-family:monospace; 
                    margin-top:auto;
                    transition: 0.3s;
                `;
                btnImmersion.innerText = "ðŸš€ IMMERSION ZQSD";

                // Effets de survol (Hover)
                btnImmersion.onmouseover = () => btnImmersion.style.background = "rgba(0,255,65,0.2)";
                btnImmersion.onmouseout = () => btnImmersion.style.background = "rgba(0,255,65,0.05)";

                btnImmersion.onclick = () => {
                    const rConf = romansConfig.find(r => r.id === item.roman);
                    const nomRoman = rConf ? rConf.nom : "Inconnu";
                    window.location.href = `visite.html?glb=${encodeURIComponent(item.glb)}&roman=${encodeURIComponent(nomRoman)}&id=${index}`;
                };
                box.appendChild(btnImmersion);
            }

            // Tri par section
            if(item.type === 'World') { 
                document.getElementById('world-section-title').style.display = 'block'; 
                worldContainer.appendChild(box); 
            }
            else if(item.type === 'Fan-Cosplay') { 
                document.getElementById('cosplay-section-title').style.display = 'block'; 
                fanContainer.appendChild(box); 
            }
            else { 
                container.appendChild(box); 
            }
        });
    }

    function activerModeMaitre() { 
        const url = new URL(window.location.href);
        url.searchParams.set('Hinaru', 'true');
        window.location.href = url.toString(); 
    }

    function toggleTomeField() { 
        const t = document.getElementById('img-type').value;
        document.getElementById('tome-input-area').style.display = (t === 'World' || t === 'Fan-Cosplay') ? 'none' : 'inline'; 
    }

    function genererCodeSignal() {
        const code = `{ url: "${document.getElementById('img-url').value}", glb: "${document.getElementById('glb-url').value}", tech: \`${document.getElementById('img-tech').value}\`, roman: ${projetActuel}, type: "${document.getElementById('img-type').value}", tome: ${document.getElementById('img-tome').value}, date: "${document.getElementById('img-date').value}", nom: "Hinaru (Creator)" },`;
        const out = document.getElementById('output-code'); out.value = code; out.style.display = 'block';
    }

    setInterval(ecouterScanner, 1000);
    window.onload = chargerGalerie;
</script>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Simulation Nébuleuse - Pilotage</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; }
        
        /* MANUEL DE PILOTAGE */
        #manual-overlay {
            position: fixed; inset: 0; background: rgba(0, 5, 10, 0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; color: #00ff41; text-align: center; border: 4px double #00ff41;
        }
        .key-box { border: 1px solid #00ff41; padding: 5px 10px; margin: 5px; display: inline-block; font-weight: bold; }
        
        #hud-pilotage { position: fixed; bottom: 20px; left: 20px; color: #00ff41; pointer-events: none; text-shadow: 0 0 5px #00ff41; font-size: 12px; }
        #crosshair { position: fixed; top: 50%; left: 50%; width: 12px; height: 12px; border: 1px solid #00ff41; transform: translate(-50%, -50%); border-radius: 50%; }
        
        button#start-btn { background: #00ff41; color: black; border: none; padding: 15px 30px; font-weight: bold; cursor: pointer; margin-top: 20px; font-family: monospace; }
    </style>
</head>
<body>

    <div id="manual-overlay">
        <h1 style="letter-spacing: 10px;">MANUEL DE PILOTAGE</h1>
        <div style="max-width: 600px; line-height: 1.6;">
            <p><span class="key-box">Z</span> Avancer | <span class="key-box">S</span> Reculer</p>
            <p><span class="key-box">Q</span> Gauche | <span class="key-box">D</span> Droite</p>
            <p><span class="key-box">CLIC GAUCHE</span> Capturer la vue (Souris pour regarder)</p>
            <p><span class="key-box">CLIC DROIT</span> Interagir avec les éléments (Portes, Fenêtres, Boutons)</p>
            <p><span class="key-box">DOUBLE ÉCHAP</span> Quitter la simulation et revenir aux archives</p>
            <hr style="border-color: #00ff41;">
            <p style="font-size: 11px; color: orange;">NOTE : Le monde se réinitialise à chaque nouvelle session.</p>
        </div>
        <button id="start-btn" onclick="demarrerSimulation()">[ INITIALISER LA LIAISON ]</button>
    </div>

    <div id="crosshair"></div>
    <div id="hud-pilotage">SYSTÈME DE LORE IMMERSIF ACTIF | ÉTAT : OPÉRATIONNEL</div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const glbToLoad = urlParams.get('glb');

        let scene, camera, renderer, mixer, clock = new THREE.Clock();
        let moveF = false, moveB = false, moveL = false, moveR = false;

        function demarrerSimulation() {
            document.getElementById('manual-overlay').style.display = 'none';
            document.body.requestPointerLock();
            init();
            animate();
        }

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 5); // Position humaine

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 1));

            const loader = new THREE.GLTFLoader();
            // LE RESET : Le chargement ici garantit que l'objet repart de zéro (état Blender)
            loader.load(glbToLoad, (gltf) => {
                scene.add(gltf.scene);
                if (gltf.animations.length > 0) {
                    mixer = new THREE.AnimationMixer(gltf.scene);
                }
            });

            // COMMANDES DE DÉPLACEMENT
            window.onkeydown = (e) => {
                if(e.code === 'KeyW') moveF = true;
                if(e.code === 'KeyS') moveB = true;
                if(e.code === 'KeyA') moveL = true;
                if(e.code === 'KeyD') moveR = true;
            };
            window.onkeyup = (e) => {
                if(e.code === 'KeyW') moveF = false;
                if(e.code === 'KeyS') moveB = false;
                if(e.code === 'KeyA') moveL = false;
                if(e.code === 'KeyD') moveR = false;
            };

            // INTERACTION CLIC DROIT
            window.oncontextmenu = (e) => {
                e.preventDefault(); // Empêche le menu Windows de s'ouvrir
                interagir();
            };

            // DOUBLE ECHAP POUR SORTIR
            let escapeCount = 0;
            window.addEventListener('keydown', (e) => {
                if(e.key === 'Escape') {
                    escapeCount++;
                    setTimeout(() => escapeCount = 0, 500);
                    if(escapeCount === 2) window.location.href = 'galerie.html';
                }
            });

            // MOUVEMENT SOURIS
            document.onmousemove = (e) => {
                if (document.pointerLockElement) {
                    camera.rotation.y -= e.movementX * 0.002;
                    camera.rotation.x -= e.movementY * 0.002;
                    camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
                }
            };
        }

        function interagir() {
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera({x: 0, y: 0}, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);
            
            if (intersects.length > 0) {
                let target = intersects[0].object;
                // Si l'objet cliqué est une porte ou une fenêtre (nommé dans Blender)
                if (target.name.includes("Porte") || target.name.includes("Fenetre")) {
                    console.log("Activation de : " + target.name);
                    // Ici le code pour jouer l'animation de l'objet
                    if(mixer) {
                        // Cherche l'action qui correspond au nom de l'objet
                        // mixer.clipAction(animation).play();
                    }
                }
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            let delta = clock.getDelta();
            let speed = 5 * delta;
            
            if (moveF) camera.translateZ(-speed);
            if (moveB) camera.translateZ(speed);
            if (moveL) camera.translateX(-speed);
            if (moveR) camera.translateX(speed);
            
            camera.position.y = 1.6; // Garde les pieds au sol
            if (mixer) mixer.update(delta);
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
